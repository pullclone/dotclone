# Agent Special Instructions for the NyxOS Flake Workflow

These instructions provide a one‑time, in‑depth orientation for agents
working on the NyxOS NixOS flake repository. Follow them before
beginning any work to understand the expected workflow, standards, and
constraints.

## Bootstrapping

### Initial Setup

1.  **Clone the repository**

<!-- -->

    git clone https://github.com/pullclone/dotclone.git
    cd dotclone

1.  **Ensure Nix flakes are enabled**

If you haven't already, add the following to your `/etc/nix/nix.conf` or
`~/.config/nix/nix.conf`:

    experimental-features = nix-command flakes

1.  **Verify tooling**

Run the bootstrap task to ensure required tools are available and
configured:

    just bootstrap

This installs dependencies, checks that `nix`, `git`, and `just` are
available, and configures direnv if present.

### Tool Requirements

- **Mandatory**: `nix` with flake support, `git`, `just`
- **Recommended**: `jq`, `shellcheck`, `shfmt`, `bat` (for pretty file
  viewing)
- **Optional**: `nix-direnv`, `lorri` (for development environments)

## Build Rules

### Flake Operations

- **Always use flakes**: invoke `nix flake check`, `nix build`, or the
  `just` tasks rather than `nix-env` or `nix-shell`.
- **Default system**: the reference host is `nyx`. You can override with
  `SYSTEM=<host>` but ensure that your changes still build for `nyx`.
- **No impure operations**: do not call `nix-shell -p` or rely on
  out‑of‑tree state. All dependencies must be expressed in `flake.nix`.

### Change Protocol

1.  **Pre‑change**:

2.  Run `just bootstrap` to verify environment

3.  Run `just lint` to check formatting and shell script compliance

4.  **During change**:

5.  Make small, atomic commits. Each commit should represent one logical
    change.

6.  Follow the commit message format defined below.

7.  Keep modules isolated. Do not edit `hardware-configuration.nix`
    unless asked. Do not introduce sysctl keys or boot parameters in
    arbitrary files.

8.  **Post‑change**:

9.  Run `just ci` (lint + build + smoke tests). Ensure it passes locally
    before pushing.

10. Update documentation: `docs/CONFIG_MAP.md` for structure changes and
    `docs/ASSERTIONS.md` for new invariants or changes to existing ones.

11. Submit a pull request following the PR requirements below.

### Constraints

- **No hardcoded paths**: Use Nix abstractions (`pkgs.*`, `config.*`)
  instead of absolute `/usr/bin` style paths.
- **No unpinned dependencies**: All inputs and packages must be pinned
  in `flake.lock`.
- **No circular imports**: Modules must import one another in an acyclic
  manner.
- **Do not modify hardware‑configuration.nix**: This file is generated
  by the installer and should be treated as read‑only.
- **Centralize sysctl**: Only `modules/tuning/sysctl.nix` (and ZRAM
  modules via `mkDefault`) may set `boot.kernel.sysctl`. Do not copy
  sysctl keys into `configuration.nix`.
- **Boot profile exclusivity**: The boot profile module enforces that
  only one of `my.boot.uki.enable` or `my.boot.secureBoot.enable` may be
  true. Do not override this guard.

## Workflow Conventions

### Commit Structure

Use Conventional Commits style to make commit messages structured and
easy to read:

    <type>(<scope>): <short description>

    <detailed explanation of what/why/how>

    <footer with issue references or notes>

**Types** might be: `feat`, `fix`, `docs`, `style`, `refactor`, `test`,
`chore`. **Scopes** can be one of the domain directories (e.g., `boot`,
`hardware`, `tuning`, `home`, `programs`, `flakes`).

### Branch Strategy

- **Main branch**: `main` (protected; direct pushes forbidden)
- **Feature branches**: `feat/<topic>` for new features or modules
- **Fix branches**: `fix/<issue>` for bug fixes
- **Docs branches**: `docs/<topic>` for documentation‑only changes

### Pull Request Requirements

1.  **Title** -- Summarize what the change does.
2.  **Description** -- Explain *what* changed, *why* it was needed, and
    *how* it was implemented.
3.  **Checklist** (include in PR body):
4.  \[ \] `just ci` passes locally
5.  \[ \] Documentation updated (`docs/CONFIG_MAP.md`,
    `docs/ASSERTIONS.md`)
6.  \[ \] New assertions added or existing updated
7.  \[ \] Tests and smoke checks updated or added
8.  **Labels** -- Apply appropriate labels (e.g., `feat`, `fix`, `docs`)
    to categorize the PR.

## Testing Strategy

### Test Levels

1.  **Lint** -- Run `just lint` to check Nix files, shell scripts, and
    formatting.
2.  **Build** -- Run `just build` or `nix flake check` to evaluate and
    build the system and Home Manager configurations.
3.  **Smoke** -- Run `just test` to verify that critical binaries exist
    (e.g., `rocminfo`, `latencyflex.json`), the bootloader profile is
    set correctly, ZRAM is configured, and Btrfs maintenance config is
    present.
4.  **Integration** -- Use the scripts in `NixOS/scripts/` for deeper
    tests; they can be run under a VM or containerised environment to
    verify service health (e.g., SDDM, NetworkManager, Netdata,
    Prometheus, Grafana).
5.  **Runtime** -- Where possible, deploy the built system into a VM
    (e.g., using `nixos-install --flake .#nyx`) and verify that the
    system boots, the login works, and user services start correctly.
    This is especially important for major changes to boot, hardware, or
    tuning modules.

### Test Coverage Requirements

- **New modules** -- Must have at least one assertion in
  `docs/ASSERTIONS.md` describing their invariants.
- **New services** -- Must include runtime checks verifying that the
  service reaches `active` state.
- **Configuration changes** -- Must not break existing functionality
  (e.g., user login, networking).
- **Critical paths** -- Bootloader selection, sysctl centralization,
  ZRAM configuration, and install facts handling must have automated or
  manual verification.

## Documentation Standards

### When to Update Documentation

- **Adding modules** -- Update `docs/CONFIG_MAP.md` with the new file
  and its responsibility.
- **Adding assertions** -- Document them in `docs/ASSERTIONS.md` under
  the appropriate section.
- **Changing behaviour** -- Update relevant sections of both docs to
  reflect new runtime characteristics or structural changes.

### Format Guidelines

- Use **GitHub Flavored Markdown**.
- Use fenced code blocks with language tags (`bash`, `nix`, `mermaid`)
  where appropriate.
- Use tables sparingly for structured data; avoid long paragraphs in
  tables.
- Use Mermaid diagrams for architecture or relationships.

## Error Handling & Troubleshooting

### Common Issues and How to Resolve

  -------------------------------------------------------------------------
  Issue                Possible Cause       Resolution
  -------------------- -------------------- -------------------------------
  Flake evaluation     Syntax error in      Run `nix flake check` for
  failure              `flake.nix` or       details; fix syntax or update
                       missing input        inputs.

  Module import error  Incorrect path or    Ensure the module exists, is
                       circular dependency  imported correctly, and imports
                                            form a DAG.

  Build failure        Package missing,     Check `nix log`, verify package
                       version conflict     names, update overlays or
                                            versions in `overlay.nix`.

  Smoke test failure   Critical binary      Ensure the relevant module is
                       missing or wrong     enabled; check
                       boot profile         `docs/ASSERTIONS.md` for
                                            invariants.

  Runtime service      Service              Inspect
  failure              misconfigured        `systemctl status <service>`;
                                            verify configuration in
                                            `configuration.nix` or module.
  -------------------------------------------------------------------------

## Agent‑Specific Guidelines

### Response Format

When posting replies as an agent (e.g., during a review or PR process),
include:

1.  **Action Summary** -- What you did.
2.  **Files Modified** -- List of new or changed files.
3.  **Validation Results** -- Summarise the output of `just ci` or other
    tests.
4.  **Next Steps** -- Suggested follow‑ups or remaining tasks.

### Example Response

    ## Action Summary

    Added a new zram profile for an ultra‑aggressive compression setting.

    ## Files Modified

    - `NixOS/modules/tuning/zram/zram-ultra.nix` (created)
    - `docs/CONFIG_MAP.md` (updated)
    - `docs/ASSERTIONS.md` (added zram ultra profile section)

    ## Validation Results

    ```bash
    $ just ci
    ✓ lint-shell passed
    ✓ flake check passed
    ✓ build completed successfully
    ✓ smoke tests passed
    CI OK

## Next Steps

- Deploy on a test VM to measure performance under heavy load.
- Add integration tests to verify that the new profile doesn't conflict
  with existing profiles. \`\`\`

### Decision Making

If unsure how to proceed:

1.  Look at similar modules or commit history to find precedent.
2.  Consult `docs/CONFIG_MAP.md` to understand where things belong.
3.  Review `docs/ASSERTIONS.md` to see how invariants are expressed.
4.  Ask clarifying questions **before** making assumptions if something
    is ambiguous.

### Priority Guidelines

1.  **Build failures** -- Must be addressed immediately; nothing else
    can proceed if the system does not build.
2.  **Test failures** -- High priority; fix or update tests as needed.
3.  **Documentation gaps** -- Medium priority; ensure docs are current
    before merging.
4.  **Code style issues** -- Low priority but should be resolved before
    merge.

## Continuous Improvement

### Feedback Loop

- **Post‑mortem** -- For significant changes or outages, document
  lessons learned and update guidelines accordingly.
- **Pattern identification** -- Note recurring pain points and propose
  automation or process improvements.
- **Documentation updates** -- Keep these instructions up to date as the
  workflow evolves.

### Process Evolution

- **Evaluate new tools** -- Suggest integration of helpful tools (e.g.,
  automated testing frameworks, CI enhancements).
- **Optimize workflow** -- Propose improvements via documentation and
  PRs; adjust the `just` tasks as needed.
- **Automate tedious tasks** -- Identify manual steps that can be
  scripted to reduce human error.

## Security & Performance Considerations

### Secret Management

- Do not store secrets in the repository. Use Nix's secret management
  mechanisms or environment variables with Age encryption when
  necessary.
- Ensure that generated keys or certificates are stored outside the repo
  or encrypted.

### Code Review & Permissions

- All changes must go through a pull request with at least one peer
  reviewer.
- Do not push to `main` directly.
- Pay special attention to changes affecting boot, encryption, or
  network configuration.

### Build & Runtime Performance

- Structure modules to maximise cache reuse and minimise rebuild scope.
- Avoid adding heavy dependencies to the host; prefer containerized
  stacks for compilers and ML toolchains.
- Use periodic testing to monitor boot times, ZRAM usage, and service
  startup times; adjust tuning accordingly.

## Agent Workflow Checklist

### Before Starting Work

- \[ \] Read `AGENTS.md` for the high‑level guidelines and repository
  purpose.
- \[ \] Review `docs/CONFIG_MAP.md` to understand file locations and
  responsibilities.
- \[ \] Review `docs/ASSERTIONS.md` to understand runtime invariants and
  build contracts.
- \[ \] Run `just bootstrap` to verify your environment and toolchain.

### During Work

- \[ \] Follow the change protocol (lint → build → test → document).
- \[ \] Make atomic commits with proper messages.
- \[ \] Update documentation concurrently with code changes.
- \[ \] Run `just lint` and `just build` frequently to catch errors
  early.

### Before Submitting

- \[ \] Run `just ci` for full validation (lint + build + smoke tests).
- \[ \] Update `docs/CONFIG_MAP.md` if you added or removed files.
- \[ \] Add or update assertions in `docs/ASSERTIONS.md` as needed.
- \[ \] Prepare a detailed PR description following the PR requirements.

### After Submission

- \[ \] Monitor CI results and address failures promptly.
- \[ \] Respond to reviewer feedback and update your PR as requested.
- \[ \] Verify that changes work in a production‑like environment (VM or
  staging system).
- \[ \] Update these instructions or other documentation if the workflow
  evolved during your changes.

------------------------------------------------------------------------
