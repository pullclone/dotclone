# Agent Special Instructions for NyxOS NixOS Flake Workflow

This document provides tailored guidance for agents working on the NyxOS NixOS flake repository.

## Bootstrapping

### Initial Setup

1. **Clone Repository**: `git clone https://github.com/pullclone/dotclone.git`
2. **Enter Directory**: `cd dotclone`
3. **Check Tools**: `just bootstrap`
4. **Verify Environment**: Ensure Nix flakes are enabled

### Tool Requirements

- **Mandatory**: `nix`, `git`, `just`
- **Recommended**: `jq`, `shellcheck`, `shfmt`
- **Optional**: `nix-direnv`, `lorri` for development

## Build Rules

### Flake Operations

- **Always use flakes**: `nix flake check`, `nix build`, etc.
- **Default system**: `nyx` (configurable via `SYSTEM` env var)
- **No impure operations**: All builds must be reproducible

### Change Protocol

1. **Pre-change**: Run `just bootstrap` and `just lint`
2. **During change**: Make atomic, focused commits
3. **Post-change**: Run `just ci` before pushing
4. **Documentation**: Update docs for all non-trivial changes

### Constraints

- **No hardcoded paths**: Use Nix expressions
- **No unpinned dependencies**: All inputs must be in flake.lock
- **No circular imports**: Modules must form DAG
- **No global state modification**: Modules must be isolated

## Workflow Conventions

### Commit Structure

```
<type>(<scope>): <description>

<detailed explanation>

<footer with issue references>
```

**Types**: `feat`, `fix`, `docs`, `style`, `refactor`, `test`, `chore`
**Scopes**: `flake`, `modules`, `home`, `waybar`, `niri`, `zram`, etc.

### Branch Strategy

- **Main branch**: `main` (protected)
- **Feature branches**: `feat/<description>`
- **Fix branches**: `fix/<issue>`
- **Documentation**: `docs/<topic>`

### Pull Request Requirements

1. **Title**: Clear and descriptive
2. **Description**: Explain what, why, and how
3. **Checklist**: 
   - [ ] `just ci` passes
   - [ ] Documentation updated
   - [ ] Assertions added/updated
   - [ ] Tests pass
4. **Labels**: Appropriate for change type

## Testing Strategy

### Test Levels

1. **Lint**: `just lint` (shellcheck, flake check)
2. **Build**: `just build` (flake evaluation)
3. **Smoke**: `just test` (critical binary verification)
4. **Integration**: Manual testing of services
5. **Runtime**: Post-deploy verification

### Test Coverage Requirements

- **New modules**: Must have corresponding assertions
- **New services**: Must have startup verification
- **Configuration changes**: Must not break existing functionality
- **Critical paths**: Must have automated checks

## Documentation Standards

### Documentation Updates Required For

- **New modules**: Add to `docs/CONFIG_MAP.md`
- **New assertions**: Add to `docs/ASSERTIONS.md`
- **New services**: Update runtime component map
- **Behavior changes**: Update relevant sections

### Documentation Format

- **Markdown**: Standard GitHub Flavored Markdown
- **Code blocks**: Use appropriate language tags
- **Tables**: For structured data
- **Diagrams**: Mermaid for architecture diagrams

## Error Handling

### Common Issues and Solutions

**Flake evaluation failure**:
- Check `flake.nix` syntax
- Verify all inputs are available
- Run `nix flake update` if needed

**Module import errors**:
- Verify module paths
- Check for circular dependencies
- Ensure all imports are explicit

**Build failures**:
- Check `nix log` for details
- Verify package availability
- Check for version conflicts

**Test failures**:
- Run individual test commands
- Check smoke test binaries
- Verify service configurations

## Agent-Specific Guidelines

### Response Format

All agent responses must include:

1. **Action Summary**: Brief description of what was done
2. **Files Modified**: List of changed/created files
3. **Validation Results**: Test outputs and build status
4. **Next Steps**: Remaining tasks or follow-up actions

### Example Response

```markdown
## Action Summary

Implemented Waybar dynamic island configuration module.

## Files Modified

- `NixOS/modules/waybar/dynamic-island.nix` (created)
- `docs/CONFIG_MAP.md` (updated)
- `docs/ASSERTIONS.md` (added Waybar assertions)

## Validation Results

```bash
$ just ci
✓ lint-shell passed
✓ flake check passed  
✓ build completed successfully
✓ smoke tests passed
CI OK
```

## Next Steps

- Test Waybar dynamic island functionality manually
- Add integration test for Waybar service startup
```

### Decision Making

**When in doubt**:
1. Check existing patterns in similar modules
2. Consult `docs/CONFIG_MAP.md` for structure
3. Review `docs/ASSERTIONS.md` for requirements
4. Ask for clarification if needed

### Priority Guidelines

1. **Build failures**: Highest priority
2. **Test failures**: High priority
3. **Documentation gaps**: Medium priority
4. **Code style issues**: Low priority

## Continuous Improvement

### Feedback Loop

- **Post-mortem**: After major changes, document lessons learned
- **Pattern identification**: Note recurring issues for process improvement
- **Documentation updates**: Keep instructions current with workflow changes

### Process Evolution

- **New tools**: Evaluate and integrate if beneficial
- **Workflow optimizations**: Propose improvements via documentation updates
- **Automation**: Identify manual processes that can be automated

## Security Considerations

### Secret Management

- **No secrets in repo**: Use Nix secrets management
- **Environment variables**: For sensitive configuration
- **Age encryption**: For secret files

### Code Review

- **No direct pushes**: All changes via PR
- **Peer review**: Required for all non-trivial changes
- **Security audit**: For changes affecting system security

## Performance Guidelines

### Build Optimization

- **Minimize rebuilds**: Structure modules for maximum reuse
- **Lazy evaluation**: Use Nix lazy evaluation where possible
- **Caching**: Leverage Nix store caching

### Runtime Performance

- **Service startup**: Minimize boot-time service activation
- **Memory usage**: Monitor ZRAM and memory compression
- **CPU usage**: Profile critical services

## Agent Workflow Checklist

### Before Starting Work

- [ ] Read `AGENTS.md` for overall guidelines
- [ ] Review `docs/CONFIG_MAP.md` for structure
- [ ] Check `docs/ASSERTIONS.md` for requirements
- [ ] Run `just bootstrap` to verify environment

### During Work

- [ ] Follow change protocol
- [ ] Make atomic commits
- [ ] Update documentation concurrently
- [ ] Run `just lint` frequently

### Before Submitting

- [ ] Run `just ci` for full validation
- [ ] Update `docs/CONFIG_MAP.md` if structure changed
- [ ] Add/update assertions in `docs/ASSERTIONS.md`
- [ ] Write clear commit messages
- [ ] Create PR with proper description

### After Submission

- [ ] Monitor CI results
- [ ] Address review feedback promptly
- [ ] Update documentation based on review
- [ ] Verify changes work in production-like environment
