name: CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  ci_push:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    concurrency:
      group: ci-${{ github.ref }}
      cancel-in-progress: true
    strategy:
      matrix:
        system_profile: [balanced, latency]
        latencyflex_enable: ['true']
    env:
      SYSTEM_PROFILE: ${{ matrix.system_profile }}
      LATENCYFLEX_ENABLE: ${{ matrix.latencyflex_enable }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4 (2026-02-05)

      - name: Disk preflight (before cleanup)
        run: |
          set -euxo pipefail
          df -h
          sudo du -sh /usr/local/lib/android /usr/share/dotnet /opt/ghc /opt/hostedtoolcache 2>/dev/null || true

      - name: Free disk space (GitHub runner)
        run: |
          set -euxo pipefail

          # Big, safe wins on ubuntu runners:
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /opt/ghc || true

          # Toolcache is huge; removing it is usually safe unless your workflow needs it
          sudo rm -rf /opt/hostedtoolcache || true

          # Remove docker images/volumes if present (often large)
          sudo docker system prune -af || true
          sudo docker volume prune -f || true

          # Clean apt caches
          sudo apt-get clean || true
          sudo rm -rf /var/lib/apt/lists/* || true

          # Show result
          df -h

      - name: Disk preflight (before cleanup)
        run: |
          set -euxo pipefail
          df -h
          sudo du -sh /usr/local/lib/android /usr/share/dotnet /opt/ghc /opt/hostedtoolcache 2>/dev/null || true

      - name: Free disk space (GitHub runner)
        run: |
          set -euxo pipefail

          # Big, safe wins on ubuntu runners:
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /opt/ghc || true

          # Toolcache is huge; removing it is usually safe unless your workflow needs it
          sudo rm -rf /opt/hostedtoolcache || true

          # Remove docker images/volumes if present (often large)
          sudo docker system prune -af || true
          sudo docker volume prune -f || true

          # Clean apt caches
          sudo apt-get clean || true
          sudo rm -rf /var/lib/apt/lists/* || true

          # Show result
          df -h

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@c5a866b6ab867e88becbed4467b93592bce69f8a # v11 (2026-02-05)
        with:
          extra-conf: |
            experimental-features = nix-command flakes

      - name: Enable Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@565684385bcd71bad329742eefe8d12f2e765b39 # v12 (2026-02-05)
        with:
          use-flakehub: false

      - name: Configure Nix substituters for CI
        run: |
          set -euxo pipefail

          mkdir -p ~/.config/nix

          # Merge (append) rather than overwrite to avoid fighting other steps.
          cat >> ~/.config/nix/nix.conf <<'EOF'
          substituters = https://cache.nixos.org
          trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=
          keep-outputs = false
          keep-derivations = false
          EOF

          nix show-config | sed -n '1,200p'

      - name: Check formatting
        run: nix develop --command just check-nixfmt

      - name: Run strict tests
        run: nix develop --command just test-strict

      - name: Disk preflight (before audit)
        run: |
          set -euxo pipefail
          df -h
          sudo du -sh /nix/store 2>/dev/null || true

      - name: Run audit
        run: nix develop --command just audit

      - name: Disk preflight (after audit)
        if: always()
        run: |
          set -euxo pipefail
          df -h
          sudo du -sh /nix/store 2>/dev/null || true

      - name: Secret scan
        run: nix develop --command just secrets-scan

      - name: Disk preflight (before flake check)
        run: |
          set -euxo pipefail
          df -h
          sudo du -sh /nix/store 2>/dev/null || true

      - name: Flake check
        run: nix flake check .

      - name: Disk preflight (after flake check)
        if: always()
        run: |
          set -euxo pipefail
          df -h
          sudo du -sh /nix/store 2>/dev/null || true

      - name: Ensure flake.lock not modified
        run: git diff --exit-code flake.lock

      - name: Nix GC (best effort)
        if: always()
        run: |
          set -euxo pipefail
          nix-collect-garbage -d || true
          sudo nix-collect-garbage -d || true
          df -h

  ci_pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    concurrency:
      group: ci-${{ github.ref }}
      cancel-in-progress: true
    strategy:
      matrix:
        system_profile: [balanced, latency]
        latencyflex_enable: ['true']
    env:
      SYSTEM_PROFILE: ${{ matrix.system_profile }}
      LATENCYFLEX_ENABLE: ${{ matrix.latencyflex_enable }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4 (2026-02-05)

      - name: Disk preflight (before cleanup)
        run: |
          set -euxo pipefail
          df -h
          sudo du -sh /usr/local/lib/android /usr/share/dotnet /opt/ghc /opt/hostedtoolcache 2>/dev/null || true

      - name: Free disk space (GitHub runner)
        run: |
          set -euxo pipefail

          # Big, safe wins on ubuntu runners:
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /opt/ghc || true

          # Toolcache is huge; removing it is usually safe unless your workflow needs it
          sudo rm -rf /opt/hostedtoolcache || true

          # Remove docker images/volumes if present (often large)
          sudo docker system prune -af || true
          sudo docker volume prune -f || true

          # Clean apt caches
          sudo apt-get clean || true
          sudo rm -rf /var/lib/apt/lists/* || true

          # Show result
          df -h

      - name: Disk preflight (before cleanup)
        run: |
          set -euxo pipefail
          df -h
          sudo du -sh /usr/local/lib/android /usr/share/dotnet /opt/ghc /opt/hostedtoolcache 2>/dev/null || true

      - name: Free disk space (GitHub runner)
        run: |
          set -euxo pipefail

          # Big, safe wins on ubuntu runners:
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /opt/ghc || true

          # Toolcache is huge; removing it is usually safe unless your workflow needs it
          sudo rm -rf /opt/hostedtoolcache || true

          # Remove docker images/volumes if present (often large)
          sudo docker system prune -af || true
          sudo docker volume prune -f || true

          # Clean apt caches
          sudo apt-get clean || true
          sudo rm -rf /var/lib/apt/lists/* || true

          # Show result
          df -h

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@c5a866b6ab867e88becbed4467b93592bce69f8a # v11 (2026-02-05)
        with:
          extra-conf: |
            experimental-features = nix-command flakes

      - name: Enable Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@565684385bcd71bad329742eefe8d12f2e765b39 # v12 (2026-02-05)
        with:
          use-flakehub: false

      - name: Configure Nix substituters for CI
        run: |
          set -euxo pipefail

          mkdir -p ~/.config/nix

          # Merge (append) rather than overwrite to avoid fighting other steps.
          cat >> ~/.config/nix/nix.conf <<'EOF'
          substituters = https://cache.nixos.org
          trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=
          keep-outputs = false
          keep-derivations = false
          EOF

          nix show-config | sed -n '1,200p'

      - name: Check formatting
        run: nix develop --command just check-nixfmt

      - name: Run strict tests
        run: nix develop --command just test-strict

      - name: Disk preflight (before audit)
        run: |
          set -euxo pipefail
          df -h
          sudo du -sh /nix/store 2>/dev/null || true

      - name: Run audit
        run: nix develop --command just audit

      - name: Disk preflight (after audit)
        if: always()
        run: |
          set -euxo pipefail
          df -h
          sudo du -sh /nix/store 2>/dev/null || true

      - name: Secret scan
        run: nix develop --command just secrets-scan

      - name: Disk preflight (before flake check)
        run: |
          set -euxo pipefail
          df -h
          sudo du -sh /nix/store 2>/dev/null || true

      - name: Flake check
        run: nix flake check .

      - name: Disk preflight (after flake check)
        if: always()
        run: |
          set -euxo pipefail
          df -h
          sudo du -sh /nix/store 2>/dev/null || true

      - name: Ensure flake.lock not modified
        run: git diff --exit-code flake.lock

      - name: Nix GC (best effort)
        if: always()
        run: |
          set -euxo pipefail
          nix-collect-garbage -d || true
          sudo nix-collect-garbage -d || true
          df -h
