name: CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  ci_push:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    concurrency:
      group: ci-${{ github.ref }}
      cancel-in-progress: true
    strategy:
      matrix:
        system_profile: [balanced, latency]
        latencyflex_enable: ['true']
    env:
      SYSTEM_PROFILE: ${{ matrix.system_profile }}
      LATENCYFLEX_ENABLE: ${{ matrix.latencyflex_enable }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4 (2026-02-05)

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@c5a866b6ab867e88becbed4467b93592bce69f8a # v11 (2026-02-05)
        with:
          extra-conf: |
            experimental-features = nix-command flakes

      - name: Enable Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@565684385bcd71bad329742eefe8d12f2e765b39 # v12 (2026-02-05)
        with:
          use-flakehub: false

      - name: Check formatting
        run: nix develop --command just check-nixfmt

      - name: Run strict tests
        run: nix develop --command just test-strict

      - name: Run audit
        run: nix develop --command just audit

      - name: Secret scan
        run: nix develop --command just secrets-scan

      - name: Flake check
        run: nix flake check .

      - name: Ensure flake.lock not modified
        run: git diff --exit-code flake.lock

  ci_pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    concurrency:
      group: ci-${{ github.ref }}
      cancel-in-progress: true
    strategy:
      matrix:
        system_profile: [balanced, latency]
        latencyflex_enable: ['true']
    env:
      SYSTEM_PROFILE: ${{ matrix.system_profile }}
      LATENCYFLEX_ENABLE: ${{ matrix.latencyflex_enable }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4 (2026-02-05)

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@c5a866b6ab867e88becbed4467b93592bce69f8a # v11 (2026-02-05)
        with:
          extra-conf: |
            experimental-features = nix-command flakes

      - name: Enable Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@565684385bcd71bad329742eefe8d12f2e765b39 # v12 (2026-02-05)
        with:
          use-flakehub: false

      - name: Check formatting
        run: nix develop --command just check-nixfmt

      - name: Run strict tests
        run: nix develop --command just test-strict

      - name: Run audit
        run: nix develop --command just audit

      - name: Secret scan
        run: nix develop --command just secrets-scan

      - name: Flake check
        run: nix flake check .

      - name: Ensure flake.lock not modified
        run: git diff --exit-code flake.lock
